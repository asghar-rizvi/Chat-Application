<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat UI</title>
        <!-- MDBootstrap -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.js"></script>
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

        <style>
            .background-radial-gradient {
                background-color: hsl(218, 41%, 15%);
                background-image: radial-gradient(650px circle at 0% 0%,
                    hsl(218, 41%, 30%) 35%,
                    hsl(218, 41%, 20%) 75%,
                    hsl(218, 41%, 19%) 80%,
                    transparent 100%);
            }

            .chat-container {
                height: 90vh;
                display: flex;
            }
            
            /* Sidebar */
            .chat-sidebar {
                background: #f8f9fa;
                padding: 15px;
                border-right: 1px solid #ddd;
                overflow-y: auto;
                height: 100%;
            }
            
            /* Friend List */
            .friend-item {
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                background: white;
                margin-bottom: 10px;
                border: 1px solid #ddd;
            }
            .friend-item:hover {
                background: #e9ecef;
            }
            
            /* Chat Window */
            .chat-window {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            /* Chat Header */
            .chat-header {
                background: #007bff;
                color: white;
                padding: 15px;
                text-align: center;
            }
            
            /* Chat Messages */
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
                background: #f1f1f1;
                height: 75%;
            }
            
            /* Chat Bubbles */
            .message {
                max-width: 60%;
                padding: 10px 15px;
                border-radius: 15px;
                margin-bottom: 10px;
            }
            .message.sent {
                background: #007bff;
                color: white;
                align-self: flex-end;
            }
            .message.received {
                background: white;
                border: 1px solid #ddd;
                align-self: flex-start;
            }
            
            /* Chat Input */
            .chat-input {
                display: flex;
                padding: 10px;
                background: white;
                border-top: 1px solid #ddd;
            }
            .chat-input input {
                flex: 1;
                margin-right: 10px;
            }

        </style>
    </head>
    <body class="background-radial-gradient">

        <nav class="navbar navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand">Chat Application</a>
                <ul class="navbar-nav d-flex flex-row gap-4">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/chat">Chat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/network/">Friend Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/searchUser/">Search</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Profile</a>
                    </li>
                </ul>
            </div>
        </nav>
        
        <div class="container-fluid">
            <div class="row chat-container">
                
                <!-- Left Sidebar: Friend List -->
                <div class="col-md-3 chat-sidebar">
                    <input type="text" id="search-friends" class="form-control mb-2" placeholder="🔍 Search friends...">
                    <div id="friends-list">
                        <!-- Friend names will be dynamically loaded here -->
                    </div>
                </div>
        
                <!-- Right: Chat Window -->
                <div class="col-md-9 chat-window">
                    <!-- Chat Header (Friend's Name) -->
                    <div class="chat-header">
                        <h5 id="chat-username">Select a friend to chat</h5>
                    </div>
        
                    <!-- Chat Messages Area -->
                    <div id="chat-messages" class="chat-messages">
                        <!-- Messages will be dynamically loaded here -->
                    </div>
        
                    <!-- Chat Input Box -->
                    <div class="chat-input">
                        <input type="text" id="message-input" class="form-control" placeholder="Type a message...">
                        <button class="btn btn-primary" id="send-button">Send</button>
                    </div>
                </div>
            </div>
        </div>

    {{user|json_script:"user-id"}}

    </body>
    <script>
    
        document.addEventListener("DOMContentLoaded", function () {
            loadFriendsList();});
            user_name = JSON.parse(document.getElementById('user-id').textContent)
        function loadFriendsList() {
            fetch('/get_friends/')
                .then(response => response.json())
                .then(data => {
                    let friendsList = document.getElementById("friends-list");
                    friendsList.innerHTML = "";
                    data.forEach(friend => {
                        let friendItem = `<div class="friend-item" onclick="fetchGroupName('${friend.name}')">${friend.name}</div>`;
                        friendsList.innerHTML += friendItem;
                    });
                })
                .catch(error => console.error("Error loading friends:", error));
        }
        
        function fetchGroupName(friendUsername) {
            if (!friendUsername) {
                console.error("Friend username is missing!");
                return;  
            }
            console.log(friendUsername)
            fetch(`/get_group_name/${friendUsername}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.group_name) {
                        console.log("Group Name:", data.group_name);
                        startWebSocket(data.group_name, friendUsername) ;
                    } else {
                        console.error("Error fetching group name:", data.error);
                    }
                })
                .catch(error => console.error("Fetch error:", error));
        }
        
        
        function startWebSocket(groupName, friendUsername) {
            const usernameElement = document.getElementById("chat-username");
            const chatMesssages = document.getElementById("chat-messages");
            const sendButton = document.getElementById("send-button");
            const messageInput = document.getElementById("message-input");
            console.log('Inside Start WebSocket...', groupName, friendUsername)
            if (!usernameElement || !chatMesssages || !sendButton || !messageInput) {
                console.error("Chat UI elements not found!");
                return;
            }
        
            usernameElement.innerText = friendUsername;
            chatMesssages.innerHTML = ""; // Clear previous messages
        
            const wsUrl = `ws://${window.location.host}/ws/chat/${groupName}/`;
            const chatSocket = new WebSocket(wsUrl);
        
            chatSocket.onopen = function () {
                console.log("WebSocket connected for group:", groupName);
            };
        
            chatSocket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                console.log('Inside On message:', data.type);
            
                if (data.type === 'chat_history') {
                    // Clear previous messages
                    chatMesssages.innerHTML = ""; 
            
                    // Loop through the chat history and display messages
                    data.messages.forEach(msg => {
                        console.log('Inside chat_history:', msg);  
                        let msgElement = document.createElement("div");
                        msgElement.innerHTML = `<strong>${msg.user}:</strong> ${msg.message}`; 
                        chatMesssages.appendChild(msgElement);
                    });
            
                } else if (data.type === 'chat_message') {
                    console.log('Receiving message:', data);
            
                    let msgElement = document.createElement("div");
                    msgElement.innerHTML = `<strong>${data.user}:</strong> ${data.message}`;  
                    chatMesssages.appendChild(msgElement);
                    chatMesssages.scrollTop = chatMesssages.scrollHeight;
                }
            };
            
        
            chatSocket.onclose = function () {
                console.log("WebSocket disconnected.");
            };
        
            sendButton.onclick = function () {
                let message = messageInput.value.trim();
        
                if (message !== "") {
                    chatSocket.send(JSON.stringify({ message: message }));
                    messageInput.value = "";
                }
            };
        
            function appendMessage(user, message) {
                let msgElement = document.createElement("div");
                msgElement.classList.add("message"); 
                msgElement.innerHTML = `${user}: ${message}`;
                chatMesssages.appendChild(msgElement);
                chatMesssages.scrollTop = chatMesssages.scrollHeight;
            }
        }
        
    </script>


</html>

